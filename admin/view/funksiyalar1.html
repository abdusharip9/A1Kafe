<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Feature Management</title>
	<!-- Bootstrap 5 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Icons -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
	<style>
		body {
			background-color: #f8f9fa;
		}

		.table-container {
			background-color: white;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.table {
			margin-bottom: 0;
		}

		.table th {
			background-color: #f1f3f5;
			border-bottom: 2px solid #dee2e6;
		}

		.table-actions {
			width: 120px;
			text-align: center;
		}

		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 9999;
			color: white;
		}

		.header-row {
			background-color: #f8f9fa;
			border-bottom: 1px solid #dee2e6;
			padding: 15px;
			margin-bottom: 0;
		}
	</style>
</head>

<body>
	<div class="container-fluid py-4">
		<div class="row header-row align-items-center mb-3">
			<div class="col-md-6">
				<h2 class="mb-0">Feature Management</h2>
			</div>
			<div class="col-md-6 text-md-end">
				<button id="createFeatureBtn" class="btn btn-primary">
					<i class="bi bi-plus-circle me-2"></i>Add New Feature
				</button>
			</div>
		</div>

		<div class="table-container">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th style="width: 15%">Code</th>
						<th style="width: 25%">Name</th>
						<th style="width: 45%">Description</th>
						<th class="table-actions">Actions</th>
					</tr>
				</thead>
				<tbody id="featuresTableBody">
					<!-- Features will be loaded here -->
				</tbody>
			</table>
			<div id="emptyState" class="text-center py-5 d-none">
				<i class="bi bi-inbox fs-1 text-muted"></i>
				<p class="mt-3 text-muted">No features found. Click "Add New Feature" to create one.</p>
			</div>
		</div>
	</div>

	<!-- Feature Modal -->
	<div class="modal fade" id="featureModal" tabindex="-1" aria-labelledby="featureModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="featureModalLabel">Add New Feature</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="featureForm">
						<input type="hidden" id="featureId" value="">
						<div class="mb-3">
							<label for="featureCode" class="form-label">Code</label>
							<input type="text" class="form-control" id="featureCode" required>
						</div>
						<div class="mb-3">
							<label for="featureName" class="form-label">Name</label>
							<input type="text" class="form-control" id="featureName" required>
						</div>
						<div class="mb-3">
							<label for="featureDescription" class="form-label">Description</label>
							<textarea class="form-control" id="featureDescription" rows="3" required></textarea>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="saveFeatureBtn">Save</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Delete Confirmation Modal -->
	<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to delete this feature? This action cannot be undone.</p>
					<p><strong>Feature: </strong><span id="deleteFeatureName"></span></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Loading Overlay -->
	<div id="loadingOverlay" class="loading-overlay d-none">
		<div class="spinner-border text-light me-3" role="status"></div>
		<span>Loading...</span>
	</div>

	<!-- Toast Notifications -->
	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
		<div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header">
				<strong class="me-auto" id="toastTitle">Notification</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="toastMessage"></div>
		</div>
	</div>

	<!-- Bootstrap 5 JS Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// DOM Elements
		const featuresTableBody = document.getElementById('featuresTableBody')
		const emptyState = document.getElementById('emptyState')
		const featureForm = document.getElementById('featureForm')
		const featureId = document.getElementById('featureId')
		const featureCode = document.getElementById('featureCode')
		const featureName = document.getElementById('featureName')
		const featureDescription = document.getElementById('featureDescription')
		const createFeatureBtn = document.getElementById('createFeatureBtn')
		const saveFeatureBtn = document.getElementById('saveFeatureBtn')
		const confirmDeleteBtn = document.getElementById('confirmDeleteBtn')
		const deleteFeatureName = document.getElementById('deleteFeatureName')
		const loadingOverlay = document.getElementById('loadingOverlay')
		const toast = document.getElementById('toast')
		const toastTitle = document.getElementById('toastTitle')
		const toastMessage = document.getElementById('toastMessage')

		// Bootstrap Modal Instances
		const featureModal = new bootstrap.Modal(document.getElementById('featureModal'))
		const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'))
		const toastInstance = new bootstrap.Toast(toast)

		// API Endpoints
		const API_ENDPOINTS = {
			CREATE: '/api/features/create',
			GET_ALL: '/api/features/get-all',
			UPDATE: (id) => `/api/features/update/${id}`,
			DELETE: (id) => `/api/features/delete/${id}`
		}

		// Show loading overlay
		function showLoading() {
			loadingOverlay.classList.remove('d-none')
		}

		// Hide loading overlay
		function hideLoading() {
			loadingOverlay.classList.add('d-none')
		}

		// Show toast notification
		function showToast(title, message, isError = false) {
			toastTitle.textContent = title
			toastMessage.textContent = message

			toast.classList.remove('bg-danger', 'text-white')
			if (isError) {
				toast.classList.add('bg-danger', 'text-white')
			}

			toastInstance.show()
		}

		// Fetch all features
		async function fetchFeatures() {
			try {
				showLoading()
				const response = await fetch(API_ENDPOINTS.GET_ALL)

				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`)
				}

				const features = await response.json()
				renderFeatures(features)
			} catch (error) {
				console.error('Error fetching features:', error)
				showToast('Error', 'Failed to load features. Please try again.', true)
			} finally {
				hideLoading()
			}
		}

		// Render features in the table
		function renderFeatures(features) {
			featuresTableBody.innerHTML = ''

			if (features.length === 0) {
				emptyState.classList.remove('d-none')
				return
			}

			emptyState.classList.add('d-none')

			features.forEach(feature => {
				const row = document.createElement('tr')
				row.innerHTML = `
                    <td>${feature.code}</td>
                    <td>${feature.name}</td>
                    <td>${feature.description}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${feature.id || feature._id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${feature.id || feature._id}" data-name="${feature.name}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `
				featuresTableBody.appendChild(row)
			})

			// Add event listeners to edit and delete buttons
			document.querySelectorAll('.edit-btn').forEach(btn => {
				btn.addEventListener('click', handleEditClick)
			})

			document.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', handleDeleteClick)
			})
		}

		// Handle create feature button click
		function handleCreateClick() {
			// Reset form
			featureForm.reset()
			featureId.value = ''

			// Update modal title
			document.getElementById('featureModalLabel').textContent = 'Add New Feature'

			// Show modal
			featureModal.show()
		}

		// Handle edit feature button click
		async function handleEditClick(event) {
			const id = event.currentTarget.dataset.id

			try {
				showLoading()
				const response = await fetch(API_ENDPOINTS.GET_ALL)

				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`)
				}

				const features = await response.json()
				const feature = features.find(f => (f.id === id || f._id === id))

				if (!feature) {
					throw new Error('Feature not found')
				}

				// Fill form with feature data
				featureId.value = id
				featureCode.value = feature.code
				featureName.value = feature.name
				featureDescription.value = feature.description

				// Update modal title
				document.getElementById('featureModalLabel').textContent = 'Edit Feature'

				// Show modal
				featureModal.show()
			} catch (error) {
				console.error('Error fetching feature details:', error)
				showToast('Error', 'Failed to load feature details. Please try again.', true)
			} finally {
				hideLoading()
			}
		}

		// Handle delete feature button click
		function handleDeleteClick(event) {
			const id = event.currentTarget.dataset.id
			const name = event.currentTarget.dataset.name

			// Set feature ID and name in delete modal
			confirmDeleteBtn.dataset.id = id
			deleteFeatureName.textContent = name

			// Show delete modal
			deleteModal.show()
		}

		// Handle save feature button click
		async function handleSaveFeature() {
			// Validate form
			if (!featureForm.checkValidity()) {
				featureForm.reportValidity()
				return
			}

			const id = featureId.value
			const isEdit = !!id

			const featureData = {
				code: featureCode.value,
				name: featureName.value,
				description: featureDescription.value
			}

			try {
				showLoading()

				const url = isEdit ? API_ENDPOINTS.UPDATE(id) : API_ENDPOINTS.CREATE
				const method = isEdit ? 'PUT' : 'POST'

				const response = await fetch(url, {
					method: method,
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(featureData)
				})

				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`)
				}

				// Close modal
				featureModal.hide()

				// Show success message
				const message = isEdit ? 'Feature updated successfully!' : 'Feature created successfully!'
				showToast('Success', message)

				// Refresh features list
				await fetchFeatures()
			} catch (error) {
				console.error('Error saving feature:', error)
				showToast('Error', 'Failed to save feature. Please try again.', true)
			} finally {
				hideLoading()
			}
		}

		// Handle confirm delete button click
		async function handleConfirmDelete() {
			const id = confirmDeleteBtn.dataset.id

			try {
				showLoading()

				const response = await fetch(API_ENDPOINTS.DELETE(id), {
					method: 'DELETE'
				})

				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`)
				}

				// Close modal
				deleteModal.hide()

				// Show success message
				showToast('Success', 'Feature deleted successfully!')

				// Refresh features list
				await fetchFeatures()
			} catch (error) {
				console.error('Error deleting feature:', error)
				showToast('Error', 'Failed to delete feature. Please try again.', true)
			} finally {
				hideLoading()
			}
		}

		// Event Listeners
		document.addEventListener('DOMContentLoaded', () => {
			// Fetch features on page load
			fetchFeatures()

			// Add event listeners
			createFeatureBtn.addEventListener('click', handleCreateClick)
			saveFeatureBtn.addEventListener('click', handleSaveFeature)
			confirmDeleteBtn.addEventListener('click', handleConfirmDelete)
		});
	</script>
</body>

</html>